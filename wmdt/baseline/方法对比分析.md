# WMDT vs AgentDebug: 方法对比分析

## 一、核心方法论对比

### 1.1 AgentDebug 核心方法

**论文**: "Where LLM Agents Fail and How They Can Learn From Failures"

**核心思想**:
- 通过**两阶段事后分析**识别导致任务失败的关键错误点
- 基于**错误分类法（Error Taxonomy）**系统化地分类错误类型
- 提供**纠正反馈（Corrective Feedback）**帮助智能体从失败中学习

**两阶段流程**:

#### Stage 1: Fine-Grained Analysis（细粒度分析）
- **目标**: 对每个步骤进行逐模块的错误检测
- **分析粒度**: 每个步骤的每个模块（Memory, Reflection, Planning, Action）
- **输出**: 每个步骤的错误类型标注

**分析模块**:
1. **Memory**: 记忆检索、幻觉、过度简化
2. **Reflection**: 进展误判、结果误解、因果归因错误
3. **Planning**: 约束忽视、不可能动作、低效计划
4. **Action**: 格式错误、参数错误、动作不匹配

#### Stage 2: Critical Error Detection（关键错误检测）
- **目标**: 识别导致任务失败的**最早关键错误**
- **方法**: 分析错误的级联效应，追溯根因
- **输出**: Critical Error（包含错误步骤、模块、类型、根因、纠正建议）

**关键特性**:
- ✅ **独立分析**: 只需要失败轨迹，不需要参考轨迹
- ✅ **可解释性**: 提供详细的错误证据和推理
- ✅ **可操作性**: 提供具体的纠正反馈
- ❌ **事后性**: 需要在任务完成后进行分析
- ❌ **执行层**: 主要分析行为输出，难以捕捉决策层的认知缺陷

---

### 1.2 WMDT 核心方法

**本研究**: "World Model Divergence Tracking: 基于 BeliefState 分歧的 PCI 定位"

**核心思想**:
- 通过追踪智能体的**内部认知状态（BeliefState）分歧**，在认知层面定位 PCI
- 对比**参考轨迹（成功路径）**与**失败轨迹**的认知差异
- 关注**风险识别分歧（risk_divergence）**作为失败的早期信号

**核心流程**:

#### Step 1: BeliefState Extraction（认知状态提取）
- **提取对象**: 每个智能体在每个步骤的 BeliefState
- **提取内容**:
  - `global_state`: 对全局状态的理解
  - `current_goal`: 当前目标
  - `teammate_model`: 对队友的认知模型
  - `identified_risks`: 识别的风险（**关键**）
- **提取方法**: 使用 LLM 的自省能力

#### Step 2: Divergence Evaluation（分歧评估）
- **对比**: 参考轨迹 vs 失败轨迹的对应 BeliefState
- **评估维度**:
  - `global_divergence`: 全局状态理解差异
  - `goal_divergence`: 目标差异
  - `teammate_divergence`: 队友模型差异
  - `risk_divergence`: **风险识别差异（核心指标）**
  - `overall_divergence`: 综合分歧分数

#### Step 3: PCI Localization（PCI 定位）
- **定位方法**: 找到 `risk_divergence` 超过阈值的最早步骤
- **PCI 定义**: 认知链条上的高风险节点，失败在此之后变得难以避免
- **输出**: PCI 的步骤、角色、分歧分数、解释

**关键特性**:
- ✅ **预防性**: 可以在执行过程中追踪认知分歧
- ✅ **认知层**: 捕捉决策层的认知缺陷，而非执行层的行为错误
- ✅ **根因定位**: 定位到上游决策者（如 PM）的认知缺陷
- ❌ **依赖参考轨迹**: 需要一条成功的参考轨迹进行对比
- ❌ **成本**: 需要对每个智能体的每个步骤提取 BeliefState

---

## 二、核心区别总结

| 维度 | AgentDebug | WMDT |
|------|-----------|------|
| **分析时机** | 事后分析（Post-hoc） | 预防性追踪（Proactive） |
| **分析对象** | 执行轨迹（行为输出） | BeliefState（内部认知） |
| **定位目标** | Critical Error（关键错误） | PCI（认知不可逆点） |
| **定位层次** | 执行层（行为错误） | 决策层（认知缺陷） |
| **方法** | 单轨迹错误分类 + 级联分析 | 双轨迹认知分歧对比 |
| **关键指标** | error_type（错误类型） | risk_divergence（风险分歧） |
| **依赖** | 失败轨迹 | 参考轨迹 + 失败轨迹 |
| **输出** | 错误步骤、模块、类型、纠正建议 | PCI 步骤、角色、分歧分数、解释 |
| **优势** | 独立分析、可操作反馈 | 根因定位、预防性 |
| **局限** | 事后性、执行层 | 需要参考轨迹、成本高 |

---

## 三、方法互补性分析

### 3.1 典型案例对比

**场景**: 电影评分系统 - rating 字段数据类型未定义

#### **AgentDebug 会如何分析**:

**Phase 1 分析**:
- Step 1 (PM 写 PRD):
  - Memory: no_error
  - Reflection: no_error
  - Planning: 可能检测到 `constraint_ignorance`（未明确数据类型约束）
  - Action: no_error

- Step 2 (Developer 写 Schema):
  - Memory: no_error
  - Reflection: no_error
  - Planning: no_error
  - Action: 可能检测到 `parameter_error`（选择了不恰当的数据类型）

**Phase 2 分析**:
- **Critical Error**: Step 2, Action 模块
- **Root Cause**: "Developer 在没有明确指导的情况下选择了错误的数据类型"
- **Correction**: "在 PRD 中明确指定数据类型"

**局限**:
- ❌ 定位到 Developer 的执行错误，而非 PM 的认知缺陷
- ❌ 无法区分"Developer 的错误选择"和"PM 的信息缺失"

---

#### **WMDT 会如何分析**:

**BeliefState 对比**:

| 步骤 | 角色 | 维度 | 参考轨迹（StrictPM） | 失败轨迹（VaguePM） | 分歧 |
|------|------|------|---------------------|-------------------|------|
| Step 0 | PM | identified_risks | "数据类型和验证规则的歧义" | "功能规格对齐、UI需求不清晰" | 0.80 |
| Step 0 | Dev | identified_risks | "某些字段数据类型缺乏清晰度" | "PRD 可能缺少特定数据类型规格" | 0.30 |

**PCI 定位**:
- **PCI**: Step 0, Role PM
- **risk_divergence**: 0.80（远超阈值 0.5）
- **Root Cause**: "VaguePM 未识别技术风险，只关注业务风险，导致 PRD 缺失关键技术细节"

**优势**:
- ✅ 定位到 PM 的认知缺陷（风险识别能力不足）
- ✅ 揭示根因：PM 对技术风险的认知盲区
- ✅ 证明 Developer 在两种情况下都识别到了问题，差异在 PM 提供的信息

---

### 3.2 互补性总结

**AgentDebug 擅长**:
- ✅ 快速定位执行层的明显错误（格式错误、参数错误）
- ✅ 提供可操作的即时反馈
- ✅ 不需要参考轨迹，适用于单次失败分析

**WMDT 擅长**:
- ✅ 定位上游决策层的认知缺陷
- ✅ 区分"执行者的错误"和"决策者的信息缺失"
- ✅ 预防性地发现潜在风险

**理想的组合**:
1. **WMDT 用于根因诊断**: 定位到认知层面的 PCI
2. **AgentDebug 用于细节分析**: 分析具体的执行错误类型
3. **双重验证**: 如果 WMDT 定位到 PM 的 PCI，AgentDebug 应该在 Developer 层面检测到相应的错误

---

## 四、对比实验设计

### 4.1 实验目标

验证 WMDT 相比 AgentDebug 的优势：
1. **根因定位准确性**: WMDT 能否更准确地定位到上游决策者？
2. **预防性**: WMDT 能否更早地发现风险（在执行错误发生前）？
3. **责任归属**: WMDT 能否避免错误地 blame 执行者？

### 4.2 实验场景

#### **场景 1: 电影评分系统（已实现）**
- **陷阱**: rating 字段数据类型未定义
- **预期 AgentDebug 结果**: 定位到 Developer 的 Action 错误
- **预期 WMDT 结果**: 定位到 PM 的认知缺陷（风险识别不足）

#### **场景 2: API 设计任务**
- **任务**: 设计一个用户认证 API
- **陷阱**: 需求未明确身份验证机制（JWT, Session, OAuth）
- **设计**:
  - **StrictPM**: 明确要求使用 JWT，列出安全风险
  - **VaguePM**: 只说"需要安全的认证"
- **预期**:
  - **AgentDebug**: 定位到 Developer 选择了不恰当的认证方式
  - **WMDT**: 定位到 PM 未识别安全风险

### 4.3 评估指标

| 指标 | AgentDebug | WMDT |
|------|-----------|------|
| **定位准确性** | Critical Error 的步骤和模块 | PCI 的步骤和角色 |
| **根因深度** | 执行层错误类型 | 决策层认知缺陷 |
| **可解释性** | 错误证据和推理 | BeliefState 分歧解释 |
| **预防价值** | 事后纠正 | 事前预警 |

### 4.4 实验流程

**For 场景 1 (电影评分系统)**:

1. **运行 WMDT 实验** (已完成)
   - 获取参考轨迹（StrictPM）
   - 获取失败轨迹（VaguePM）
   - 定位 PCI

2. **适配 AgentDebug 格式**
   - 将失败轨迹转换为 AgentDebug 的 chat_history 格式
   - 标注 Memory, Reflection, Planning, Action 模块

3. **运行 AgentDebug 分析**
   - Phase 1: Fine-Grained Analysis
   - Phase 2: Critical Error Detection

4. **对比分析**
   - 对比定位结果（PCI vs Critical Error）
   - 对比根因解释
   - 评估哪个方法更接近"真实根因"

**For 场景 2 (API 设计)**:

1. **设计并运行实验**
   - 实现 StrictPM 和 VaguePM 的 API 设计变体
   - 实现 APIDesigner 角色
   - 运行双轨迹实验

2. **分别应用两种方法**
   - WMDT: 分析 BeliefState 分歧
   - AgentDebug: 分析执行轨迹错误

3. **对比验证**

---

## 五、预期贡献

通过对比实验，我们预期证明：

1. **WMDT 的独特价值**:
   - 能够定位到 AgentDebug 无法捕捉的**认知层缺陷**
   - 能够纠正**责任归属错误**（避免 blame 执行者）
   - 能够提供**预防性洞察**

2. **方法互补性**:
   - AgentDebug 适合执行层错误的快速诊断
   - WMDT 适合决策层认知缺陷的根因分析
   - 两者结合可以提供完整的故障分析视角

3. **WMDT 的适用场景**:
   - 多角色协作场景（PM + Developer）
   - 决策-执行分离的任务
   - 需要根因分析的复杂失败

---

## 六、下一步工作

- [x] 克隆 AgentDebug 代码库
- [x] 理解 AgentDebug 的核心方法
- [x] 撰写方法对比分析
- [ ] 将 WMDT 的失败轨迹转换为 AgentDebug 格式
- [ ] 运行 AgentDebug 分析电影评分系统场景
- [ ] 对比 WMDT 和 AgentDebug 的分析结果
- [ ] （可选）设计并实现场景 2（API 设计）
- [ ] 撰写对比实验报告

---

**日期**: 2025-10-08
**作者**: haoxuan004
**版本**: v1.0
